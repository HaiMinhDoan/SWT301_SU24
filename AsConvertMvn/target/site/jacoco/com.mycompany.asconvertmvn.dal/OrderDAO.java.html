<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OrderDAO.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">AsConvertMvn-1.0-SNAPSHOT</a> &gt; <a href="index.source.html" class="el_package">com.mycompany.asconvertmvn.dal</a> &gt; <span class="el_source">OrderDAO.java</span></div><h1>OrderDAO.java</h1><pre class="source lang-java linenums">/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 * Click nbfs://nbhost/SystemFileSystem/Templates/Classes/Class.java to edit this template
 */
package com.mycompany.asconvertmvn.dal;

import com.mycompany.asconvertmvn.model.Cart;
import com.mycompany.asconvertmvn.model.Customer;
import com.mycompany.asconvertmvn.model.Item;
import com.mycompany.asconvertmvn.model.Order;
import com.mycompany.asconvertmvn.model.OrderDetail;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDate;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.logging.Level;
import java.util.logging.Logger;

/**
 *
 * @author tranm
 */
public class OrderDAO {

<span class="nc" id="L30">    private static final Logger logger = Logger.getLogger(OrderDAO.class.getName());</span>

<span class="nc" id="L32">    public static final OrderDAO INSTANCE = new OrderDAO();</span>
    private Connection con;

<span class="nc" id="L35">    public OrderDAO() {</span>

<span class="nc" id="L37">        con = new DBContext().connection;</span>

<span class="nc" id="L39">    }</span>

    public boolean addOrder(Customer cus, Cart cart) {
<span class="nc" id="L42">        LocalDate curDate = java.time.LocalDate.now();</span>
<span class="nc" id="L43">        String date = curDate.toString();</span>
<span class="nc" id="L44">        PreparedStatement ps = null;</span>
<span class="nc" id="L45">        ResultSet rs = null;</span>
        try {
<span class="nc" id="L47">            String sql = &quot;insert into [Order](CustomerID, OrderDate) values (?, ?)&quot;;</span>
<span class="nc" id="L48">            ps = con.prepareStatement(sql);</span>
<span class="nc" id="L49">            ps.setInt(1, cus.getCustomerId());</span>
<span class="nc" id="L50">            ps.setString(2, date);</span>
<span class="nc" id="L51">            ps.executeUpdate();</span>
<span class="nc" id="L52">            String sql1 = &quot;select top 1 OrderId from [Order] order by OrderId desc&quot;;</span>
<span class="nc" id="L53">            PreparedStatement ps1 = con.prepareStatement(sql1);</span>
<span class="nc" id="L54">            rs = ps1.executeQuery();</span>
<span class="nc bnc" id="L55" title="All 2 branches missed.">            if (rs.next()) {</span>
<span class="nc" id="L56">                int orderId = rs.getInt(1);</span>
<span class="nc bnc" id="L57" title="All 2 branches missed.">                for (Item item : cart.getItems()) {</span>
<span class="nc" id="L58">                    String sql2 = &quot;insert into OrderDetail(OrderID, ProductID, Quantity, Price) values (?, ?, ?, ?)&quot;;</span>
<span class="nc" id="L59">                    PreparedStatement ps2 = con.prepareStatement(sql2);</span>
<span class="nc" id="L60">                    ps2.setInt(1, orderId);</span>
<span class="nc" id="L61">                    ps2.setInt(2, item.getProduct().getProductId());</span>
<span class="nc" id="L62">                    ps2.setInt(3, item.getQuantity());</span>
<span class="nc" id="L63">                    ps2.setDouble(4, item.getPrice());</span>
<span class="nc" id="L64">                    ps2.executeUpdate();</span>
<span class="nc" id="L65">                }</span>
            }
<span class="nc" id="L67">            return true;</span>
<span class="nc" id="L68">        } catch (SQLException e) {</span>
<span class="nc" id="L69">            logger.log(Level.SEVERE, &quot;&quot;, e);</span>

        } finally {
            try {
<span class="nc bnc" id="L73" title="All 2 branches missed.">                if (rs != null) {</span>
<span class="nc" id="L74">                    rs.close();</span>
                }
<span class="nc bnc" id="L76" title="All 2 branches missed.">                if (ps != null) {</span>
<span class="nc" id="L77">                    ps.close();</span>
                }
<span class="nc" id="L79">            } catch (SQLException e) {</span>
<span class="nc" id="L80">                logger.log(Level.SEVERE, &quot;&quot;, e);</span>
<span class="nc" id="L81">            }</span>

        }

<span class="nc" id="L85">        return false;</span>
    }

    public boolean addOrderByCusId(int cusId, Cart cart) {
<span class="nc" id="L89">        LocalDate curDate = java.time.LocalDate.now();</span>
<span class="nc" id="L90">        String date = curDate.toString();</span>
<span class="nc" id="L91">        PreparedStatement ps = null;</span>
<span class="nc" id="L92">        ResultSet rs = null;</span>
        try {
<span class="nc" id="L94">            String sql = &quot;insert into [Order](CustomerID, OrderDate) values (?, ?)&quot;;</span>
<span class="nc" id="L95">            ps = con.prepareStatement(sql);</span>
<span class="nc" id="L96">            ps.setInt(1, cusId);</span>
<span class="nc" id="L97">            ps.setString(2, date);</span>
<span class="nc" id="L98">            ps.executeUpdate();</span>
<span class="nc" id="L99">            String sql1 = &quot;select top 1 OrderId from [Order] order by OrderId desc&quot;;</span>
<span class="nc" id="L100">            PreparedStatement ps1 = con.prepareStatement(sql1);</span>
<span class="nc" id="L101">            rs = ps1.executeQuery();</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">            if (rs.next()) {</span>
<span class="nc" id="L103">                int orderId = rs.getInt(1);</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">                for (Item item : cart.getItems()) {</span>
<span class="nc" id="L105">                    String sql2 = &quot;insert into OrderDetail(OrderID, ProductID, Quantity, Price) values (?, ?, ?, ?)&quot;;</span>
<span class="nc" id="L106">                    PreparedStatement ps2 = con.prepareStatement(sql2);</span>
<span class="nc" id="L107">                    ps2.setInt(1, orderId);</span>
<span class="nc" id="L108">                    ps2.setInt(2, item.getProduct().getProductId());</span>
<span class="nc" id="L109">                    ps2.setInt(3, item.getQuantity());</span>
<span class="nc" id="L110">                    ps2.setDouble(4, item.getPrice());</span>
<span class="nc" id="L111">                    ps2.executeUpdate();</span>
<span class="nc" id="L112">                }</span>
            }
<span class="nc" id="L114">            return true;</span>
<span class="nc" id="L115">        } catch (SQLException e) {</span>
<span class="nc" id="L116">            logger.log(Level.SEVERE, &quot;&quot;, e);</span>

        } finally {
            try {
<span class="nc bnc" id="L120" title="All 2 branches missed.">                if (rs != null) {</span>
<span class="nc" id="L121">                    rs.close();</span>
                }
<span class="nc bnc" id="L123" title="All 2 branches missed.">                if (ps != null) {</span>
<span class="nc" id="L124">                    ps.close();</span>
                }
<span class="nc" id="L126">            } catch (SQLException e) {</span>
<span class="nc" id="L127">                logger.log(Level.SEVERE, &quot;&quot;, e);</span>
<span class="nc" id="L128">            }</span>

        }

<span class="nc" id="L132">        return false;</span>
    }

    public List&lt;Order&gt; getAllOrder() {
<span class="nc" id="L136">        List&lt;Order&gt; list = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L137">        String sql = &quot;select * from [Order]&quot;;</span>
<span class="nc" id="L138">        PreparedStatement ps = null;</span>
<span class="nc" id="L139">        ResultSet rs = null;</span>
        try {
<span class="nc" id="L141">            ps = con.prepareStatement(sql);</span>
<span class="nc" id="L142">            rs = ps.executeQuery();</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">            while (rs.next()) {</span>
<span class="nc" id="L144">                Order o = new Order();</span>
<span class="nc" id="L145">                o.setOrderId(rs.getInt(&quot;OrderID&quot;));</span>
<span class="nc" id="L146">                o.setCustomerId(rs.getInt(&quot;CustomerID&quot;));</span>
<span class="nc" id="L147">                o.setOrderDate(rs.getDate(&quot;OrderDate&quot;).toString());</span>
<span class="nc" id="L148">                list.add(o);</span>
<span class="nc" id="L149">            }</span>
<span class="nc" id="L150">        } catch (SQLException e) {</span>
<span class="nc" id="L151">            logger.log(Level.SEVERE, &quot;&quot;, e);</span>

        } finally {
            try {
<span class="nc bnc" id="L155" title="All 2 branches missed.">                if (rs != null) {</span>
<span class="nc" id="L156">                    rs.close();</span>
                }
<span class="nc bnc" id="L158" title="All 2 branches missed.">                if (ps != null) {</span>
<span class="nc" id="L159">                    ps.close();</span>
                }
<span class="nc" id="L161">            } catch (SQLException e) {</span>
<span class="nc" id="L162">                logger.log(Level.SEVERE, &quot;&quot;, e);</span>
<span class="nc" id="L163">            }</span>

        }

<span class="nc" id="L167">        return list;</span>
    }

    public Map&lt;String, Integer&gt; getOrderWithCategory() {
<span class="nc" id="L171">        Map&lt;String, Integer&gt; orders = new HashMap&lt;&gt;();</span>

<span class="nc" id="L173">        String sql = &quot;SELECT c.CategoryName, COALESCE(SUM(od.Quantity), 0) AS TotalSold\n&quot;</span>
                + &quot;FROM Category c\n&quot;
                + &quot;LEFT JOIN Product p ON c.CategoryID = p.CategoryID\n&quot;
                + &quot;LEFT JOIN OrderDetail od ON p.ProductID = od.ProductID\n&quot;
                + &quot;GROUP BY c.CategoryName;&quot;;
<span class="nc" id="L178">        PreparedStatement ps = null;</span>
<span class="nc" id="L179">        ResultSet rs = null;</span>
        try {
<span class="nc" id="L181">            ps = con.prepareStatement(sql);</span>
<span class="nc" id="L182">            rs = ps.executeQuery();</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">            while (rs.next()) {</span>
<span class="nc" id="L184">                orders.put(rs.getString(&quot;CategoryName&quot;), rs.getInt(&quot;TotalSold&quot;));</span>
            }
<span class="nc" id="L186">        } catch (SQLException e) {</span>
<span class="nc" id="L187">            logger.log(Level.SEVERE, &quot;&quot;, e);</span>

        } finally {
            try {
<span class="nc bnc" id="L191" title="All 2 branches missed.">                if (rs != null) {</span>
<span class="nc" id="L192">                    rs.close();</span>
                }
<span class="nc bnc" id="L194" title="All 2 branches missed.">                if (ps != null) {</span>
<span class="nc" id="L195">                    ps.close();</span>
                }
<span class="nc" id="L197">            } catch (SQLException e) {</span>
<span class="nc" id="L198">                logger.log(Level.SEVERE, &quot;&quot;, e);</span>
<span class="nc" id="L199">            }</span>

        }

<span class="nc" id="L203">        return orders;</span>
    }

    public int getTotalOrder() {
<span class="nc" id="L207">        String sql = &quot;select count(*) as TotalOrder from [Order]&quot;;</span>
<span class="nc" id="L208">        int count = 0;</span>
<span class="nc" id="L209">        PreparedStatement ps = null;</span>
<span class="nc" id="L210">        ResultSet rs = null;</span>
        try {
<span class="nc" id="L212">            ps = con.prepareStatement(sql);</span>
<span class="nc" id="L213">            rs = ps.executeQuery();</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">            if (rs.next()) {</span>
<span class="nc" id="L215">                count = rs.getInt(&quot;TotalOrder&quot;);</span>

            }
<span class="nc" id="L218">        } catch (SQLException e) {</span>
<span class="nc" id="L219">            logger.log(Level.SEVERE, &quot;&quot;, e);</span>

        } finally {
            try {
<span class="nc bnc" id="L223" title="All 2 branches missed.">                if (rs != null) {</span>
<span class="nc" id="L224">                    rs.close();</span>
                }
<span class="nc bnc" id="L226" title="All 2 branches missed.">                if (ps != null) {</span>
<span class="nc" id="L227">                    ps.close();</span>
                }
<span class="nc" id="L229">            } catch (SQLException e) {</span>
<span class="nc" id="L230">                logger.log(Level.SEVERE, &quot;&quot;, e);</span>
<span class="nc" id="L231">            }</span>

        }

<span class="nc" id="L235">        return count;</span>
    }

    public Map&lt;Integer, Integer&gt; getProductSold() {
<span class="nc" id="L239">        Map&lt;Integer, Integer&gt; hash = new HashMap&lt;&gt;();</span>
<span class="nc" id="L240">        String sql = &quot;	SELECT p.ProductID, COUNT(o.OrderID) AS NumberOfOrders\n&quot;</span>
                + &quot;FROM Product p\n&quot;
                + &quot;LEFT JOIN OrderDetail od ON p.ProductID = od.ProductID\n&quot;
                + &quot;LEFT JOIN [Order] o ON od.OrderID = o.OrderID\n&quot;
                + &quot;GROUP BY p.ProductID\n&quot;
                + &quot;ORDER BY NumberOfOrders DESC;&quot;;
<span class="nc" id="L246">        PreparedStatement ps = null;</span>
<span class="nc" id="L247">        ResultSet rs = null;</span>

        try {
<span class="nc" id="L250">            ps = con.prepareStatement(sql);</span>
<span class="nc" id="L251">            rs = ps.executeQuery();</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">            while (rs.next()) {</span>
<span class="nc" id="L253">                hash.put(rs.getInt(&quot;ProductId&quot;), rs.getInt(&quot;NumberOfOrders&quot;));</span>
            }
<span class="nc" id="L255">        } catch (SQLException e) {</span>
<span class="nc" id="L256">            logger.log(Level.SEVERE, &quot;&quot;, e);</span>

        } finally {
            try {
<span class="nc bnc" id="L260" title="All 2 branches missed.">                if (rs != null) {</span>
<span class="nc" id="L261">                    rs.close();</span>
                }
<span class="nc bnc" id="L263" title="All 2 branches missed.">                if (ps != null) {</span>
<span class="nc" id="L264">                    ps.close();</span>
                }
<span class="nc" id="L266">            } catch (SQLException e) {</span>
<span class="nc" id="L267">                logger.log(Level.SEVERE, &quot;&quot;, e);</span>
<span class="nc" id="L268">            }</span>

        }

<span class="nc" id="L272">        return hash;</span>
    }

    public double getAllTotalMoney() {
<span class="nc" id="L276">        String sql = &quot;SELECT SUM(od.Quantity * od.Price) AS TotalEarnings\n&quot;</span>
                + &quot;FROM [Order] o\n&quot;
                + &quot;JOIN OrderDetail od ON o.OrderID = od.OrderID&quot;;
<span class="nc" id="L279">        double total = 0;</span>
<span class="nc" id="L280">        PreparedStatement ps = null;</span>
<span class="nc" id="L281">        ResultSet rs = null;</span>
        try {
<span class="nc" id="L283">            ps = con.prepareStatement(sql);</span>
<span class="nc" id="L284">            rs = ps.executeQuery();</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">            if (rs.next()) {</span>
<span class="nc" id="L286">                total = rs.getDouble(&quot;TotalEarnings&quot;);</span>
            }
<span class="nc" id="L288">        } catch (SQLException e) {</span>
<span class="nc" id="L289">            logger.log(Level.SEVERE, &quot;&quot;, e);</span>

<span class="nc" id="L291">        }</span>
<span class="nc" id="L292">        return total;</span>
    }

    public Map&lt;String, Double&gt; getMonthlyMoney() {
<span class="nc" id="L296">        Map&lt;String, Double&gt; hash = new HashMap&lt;&gt;();</span>
<span class="nc" id="L297">        String sql = &quot;SELECT MONTH(o.OrderDate) AS Month, SUM(od.Quantity * od.Price) AS MonthlyTotalMoney\n&quot;</span>
                + &quot;FROM  [Order] o INNER JOIN   OrderDetail od ON o.OrderID = od.OrderID GROUP BY  YEAR(o.OrderDate), MONTH(o.OrderDate)\n&quot;
                + &quot;ORDER BY  Month;&quot;;
<span class="nc" id="L300">        PreparedStatement ps = null;</span>
<span class="nc" id="L301">        ResultSet rs = null;</span>
        try {
<span class="nc" id="L303">            ps = con.prepareStatement(sql);</span>
<span class="nc" id="L304">            rs = ps.executeQuery();</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">            while (rs.next()) {</span>
<span class="nc" id="L306">                hash.put(rs.getString(&quot;Month&quot;), rs.getDouble(&quot;MonthlyTotalMoney&quot;));</span>
            }
<span class="nc" id="L308">        } catch (SQLException e) {</span>
<span class="nc" id="L309">            logger.log(Level.SEVERE, &quot;&quot;, e);</span>

        } finally {
            try {
<span class="nc bnc" id="L313" title="All 2 branches missed.">                if (rs != null) {</span>
<span class="nc" id="L314">                    rs.close();</span>
                }
<span class="nc bnc" id="L316" title="All 2 branches missed.">                if (ps != null) {</span>
<span class="nc" id="L317">                    ps.close();</span>
                }
<span class="nc" id="L319">            } catch (SQLException e) {</span>
<span class="nc" id="L320">                logger.log(Level.SEVERE, &quot;&quot;, e);</span>
<span class="nc" id="L321">            }</span>

        }

<span class="nc" id="L325">        return hash;</span>

    }

    public List&lt;OrderDetail&gt; getAllOrderDetail() {
<span class="nc" id="L330">        List&lt;OrderDetail&gt; list = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L331">        String sql = &quot;select * from  OrderDetail&quot;;</span>

<span class="nc" id="L333">        PreparedStatement ps = null;</span>
<span class="nc" id="L334">        ResultSet rs = null;</span>
        try {
<span class="nc" id="L336">            ps = con.prepareStatement(sql);</span>
<span class="nc" id="L337">            rs = ps.executeQuery();</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">            while (rs.next()) {</span>
<span class="nc" id="L339">                OrderDetail od = new OrderDetail();</span>
<span class="nc" id="L340">                od.setOrderId(rs.getInt(&quot;OrderID&quot;));</span>
<span class="nc" id="L341">                od.setProductId(rs.getInt(&quot;ProductID&quot;));</span>
<span class="nc" id="L342">                od.setQuantity(rs.getInt(&quot;Quantity&quot;));</span>
<span class="nc" id="L343">                od.setPrice(rs.getDouble(&quot;Price&quot;));</span>
<span class="nc" id="L344">                list.add(od);</span>
<span class="nc" id="L345">            }</span>
<span class="nc" id="L346">        } catch (SQLException e) {</span>
<span class="nc" id="L347">            logger.log(Level.SEVERE, &quot;&quot;, e);</span>

        } finally {
            try {
<span class="nc bnc" id="L351" title="All 2 branches missed.">                if (rs != null) {</span>
<span class="nc" id="L352">                    rs.close();</span>
                }
<span class="nc bnc" id="L354" title="All 2 branches missed.">                if (ps != null) {</span>
<span class="nc" id="L355">                    ps.close();</span>
                }
<span class="nc" id="L357">            } catch (SQLException e) {</span>
<span class="nc" id="L358">                logger.log(Level.SEVERE, &quot;&quot;, e);</span>
<span class="nc" id="L359">            }</span>

        }
<span class="nc" id="L362">        return list;</span>
    }

    public void deleteOrderById(int orderId) {
<span class="nc" id="L366">        String sql = &quot;delete OrderDetail where  OrderID = ?&quot;;</span>
<span class="nc" id="L367">        PreparedStatement ps1 = null;</span>

        try {
<span class="nc" id="L370">            ps1 = con.prepareStatement(sql);</span>
<span class="nc" id="L371">            ps1.setInt(1, orderId);</span>
<span class="nc" id="L372">            ps1.executeUpdate();</span>
<span class="nc" id="L373">            String sql1 = &quot;delete [Order] where  OrderID = ?&quot;;</span>
<span class="nc" id="L374">            PreparedStatement ps2 = con.prepareStatement(sql1);</span>
<span class="nc" id="L375">            ps2.setInt(1, orderId);</span>
<span class="nc" id="L376">            ps2.executeUpdate();</span>

<span class="nc" id="L378">        } catch (SQLException e) {</span>
<span class="nc" id="L379">            logger.log(Level.SEVERE, &quot;&quot;, e);</span>

        } finally {
            try {

<span class="nc bnc" id="L384" title="All 2 branches missed.">                if (ps1 != null) {</span>
<span class="nc" id="L385">                    ps1.close();</span>
                }
<span class="nc" id="L387">            } catch (SQLException e) {</span>
<span class="nc" id="L388">                logger.log(Level.SEVERE, &quot;&quot;, e);</span>
<span class="nc" id="L389">            }</span>

        }
<span class="nc" id="L392">    }</span>

    public static void main(String[] args) {

<span class="nc" id="L396">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>